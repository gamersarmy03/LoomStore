<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoomStore - Admin Console</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Primary dark black theme */
            color: #ffffff; /* White text for contrast */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar {
            width: 8px;
            background-color: #1a1a1a;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #a020f0; /* Vibrant purple secondary color */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #8a1be6;
        }

        .card-container {
            @apply bg-gray-900 p-6 rounded-2xl shadow-xl border border-purple-700 mb-6;
        }
        .btn-action {
            @apply font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out transform hover:-translate-y-0.5;
        }
        .btn-approve {
            @apply bg-green-600 hover:bg-green-700 text-white btn-action;
        }
        .btn-reject {
            @apply bg-red-600 hover:bg-red-700 text-white btn-action;
        }
        .btn-upload-apk {
            @apply bg-purple-600 hover:bg-purple-700 text-white btn-action;
        }

        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        /* Message Box Styles (re-used from developer.html for consistency) */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1a1a1a;
            border: 2px solid #a020f0;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 90vw;
            width: 400px;
            text-align: center;
        }
        .message-box h3 {
            color: #a020f0;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .message-box p {
            color: #ffffff;
            margin-bottom: 1.5rem;
        }
        .message-box button {
            @apply bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-5 rounded-lg transition duration-200;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- Message Box Element -->
    <div id="messageBox" class="message-box">
        <h3 id="messageBoxTitle"></h3>
        <p id="messageBoxContent"></p>
        <button id="messageBoxCloseBtn">OK</button>
    </div>

    <!-- APK Upload Modal -->
    <div id="apkUploadModal" class="fixed inset-0 flex items-center justify-center hidden modal-overlay z-50 p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl p-8 w-full max-w-lg transform transition-all scale-95 opacity-0 duration-300" id="apkModalContent">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-400">Upload APK for <span id="apkAppName"></span></h2>
                <button id="closeApkModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="mb-4">
                <label for="modalApkFile" class="block text-purple-300 text-sm font-semibold mb-2">Select .apk File</label>
                <input type="file" id="modalApkFile" accept=".apk" class="w-full bg-gray-800 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-600 shadow-md cursor-pointer" required>
                <p id="modalApkFileError" class="text-red-400 text-sm mt-1"></p>
            </div>
            <button id="confirmApkUploadBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:-translate-y-1 w-full flex items-center justify-center">
                <span id="confirmApkUploadBtnText">Upload & Approve</span>
                <svg id="apkUploadSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Header Section -->
    <header class="bg-black text-white p-4 shadow-lg sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center px-4">
            <h1 class="text-3xl font-bold text-white tracking-wider">LoomStore Admin Console</h1>
            <!-- Could add admin user info/logout here later -->
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-4 md:p-8">
        <h2 class="text-2xl font-semibold mb-6 text-purple-300">Pending App Submissions</h2>

        <div id="pendingAppsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- App submission cards will be loaded here -->
            <div class="col-span-full text-center p-8 bg-gray-800 rounded-lg border border-purple-700">
                <p class="text-gray-400 mb-2">Loading pending applications...</p>
                <svg class="animate-spin h-8 w-8 text-purple-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-black text-gray-400 p-4 text-center border-t border-purple-900 mt-auto">
        <p>&copy; 2025 LoomStore Admin. All rights reserved.</p>
    </footer>

    <script type="module">
        // Import Appwrite SDK components
        import { Client, Databases, Storage, Query } from 'https://sdk.cloud.appwrite.io/docs/client.js';
        import { ID } from 'https://sdk.cloud.appwrite.io/docs/client.js'; // For unique IDs for files

        // Appwrite Configuration
        const APPWRITE_PROJECT_ID = '68528057001314063369';
        const APPWRITE_DATABASE_ID = '6852a77b0029f40ae7a4';
        const APPWRITE_COLLECTION_ID = '6852a7a3001e4713b6f6';
        const APPWRITE_BUCKET_ID = '6852a7cf0025178553d1';

        // Initialize Appwrite Client
        const client = new Client()
            .setEndpoint('https://cloud.appwrite.io/v1')
            .setProject(APPWRITE_PROJECT_ID);

        const databases = new Databases(client);
        const storage = new Storage(client);

        // --- DOM Elements ---
        const pendingAppsContainer = document.getElementById('pendingAppsContainer');

        // Message Box Elements
        const messageBox = document.getElementById('messageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        // APK Upload Modal Elements
        const apkUploadModal = document.getElementById('apkUploadModal');
        const apkModalContent = document.getElementById('apkModalContent');
        const closeApkModalBtn = document.getElementById('closeApkModalBtn');
        const apkAppName = document.getElementById('apkAppName');
        const modalApkFile = document.getElementById('modalApkFile');
        const modalApkFileError = document.getElementById('modalApkFileError');
        const confirmApkUploadBtn = document.getElementById('confirmApkUploadBtn');
        const confirmApkUploadBtnText = document.getElementById('confirmApkUploadBtnText');
        const apkUploadSpinner = document.getElementById('apkUploadSpinner');

        let currentAppIdToUpdate = null; // To store the ID of the app being processed by the modal

        /**
         * Displays a custom message box.
         * @param {string} title - The title of the message box.
         * @param {string} message - The content of the message.
         * @param {function} [onCloseCallback] - Optional callback function to execute when the box is closed.
         */
        function showMessageBox(title, message, onCloseCallback = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBox.style.display = 'flex';
            const closeHandler = () => {
                messageBox.style.display = 'none';
                messageBoxCloseBtn.removeEventListener('click', closeHandler);
                if (onCloseCallback) {
                    onCloseCallback();
                }
            };
            messageBoxCloseBtn.addEventListener('click', closeHandler);
        }

        /**
         * Shows the APK upload modal.
         * @param {string} appId - The ID of the app to update.
         * @param {string} appName - The name of the app to display in the modal title.
         */
        function showApkUploadModal(appId, appName) {
            currentAppIdToUpdate = appId;
            apkAppName.textContent = appName;
            modalApkFile.value = ''; // Clear previous file selection
            modalApkFileError.textContent = ''; // Clear previous error
            confirmApkUploadBtn.disabled = false;
            confirmApkUploadBtnText.classList.remove('hidden');
            apkUploadSpinner.classList.add('hidden');

            apkUploadModal.classList.remove('hidden');
            setTimeout(() => {
                apkModalContent.classList.remove('opacity-0', 'scale-95');
                apkModalContent.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        /**
         * Hides the APK upload modal.
         */
        function hideApkUploadModal() {
            apkModalContent.classList.remove('opacity-100', 'scale-100');
            apkModalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                apkUploadModal.classList.add('hidden');
            }, 300);
        }

        // --- Event Listeners for APK Modal ---
        closeApkModalBtn.addEventListener('click', hideApkUploadModal);
        apkUploadModal.addEventListener('click', (event) => {
            if (event.target === apkUploadModal) {
                hideApkUploadModal();
            }
        });

        confirmApkUploadBtn.addEventListener('click', async () => {
            const apkFile = modalApkFile.files[0];
            if (!apkFile) {
                modalApkFileError.textContent = 'Please select an APK file.';
                return;
            }
            if (apkFile.type !== 'application/vnd.android.package-archive') {
                modalApkFileError.textContent = 'Invalid file type. Please upload an APK file (.apk).';
                return;
            }

            confirmApkUploadBtn.disabled = true;
            confirmApkUploadBtnText.classList.add('hidden');
            apkUploadSpinner.classList.remove('hidden');
            modalApkFileError.textContent = ''; // Clear error on submit

            try {
                // Upload APK file to Appwrite Storage
                const apkFileId = ID.unique();
                await storage.createFile(
                    APPWRITE_BUCKET_ID,
                    apkFileId,
                    apkFile,
                    ['role:any'] // Public read permissions
                );
                const apkUrl = `${client.config.endpoint}/storage/buckets/${APPWRITE_BUCKET_ID}/files/${apkFileId}/view?project=${APPWRITE_PROJECT_ID}`;

                // Update the app document in Appwrite
                await databases.updateDocument(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_COLLECTION_ID,
                    currentAppIdToUpdate,
                    {
                        status: 'approved',
                        apkUrl: apkUrl,
                        reviewedBy: 'Admin User', // Placeholder for admin name
                        reviewDate: new Date().toISOString()
                    }
                );

                showMessageBox('Success', 'APK uploaded and app approved successfully!', () => {
                    hideApkUploadModal();
                    fetchPendingApps(); // Refresh the list
                });

            } catch (error) {
                console.error("Error uploading APK or approving app:", error);
                modalApkFileError.textContent = `Upload failed: ${error.message}`;
            } finally {
                confirmApkUploadBtn.disabled = false;
                confirmApkUploadBtnText.classList.remove('hidden');
                apkUploadSpinner.classList.add('hidden');
            }
        });

        // --- Core Functions ---

        /**
         * Fetches and displays pending app submissions.
         */
        async function fetchPendingApps() {
            pendingAppsContainer.innerHTML = `
                <div class="col-span-full text-center p-8 bg-gray-800 rounded-lg border border-purple-700">
                    <p class="text-gray-400 mb-2">Loading pending applications...</p>
                    <svg class="animate-spin h-8 w-8 text-purple-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            `;
            try {
                const response = await databases.listDocuments(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_COLLECTION_ID,
                    [Query.equal('status', 'pending')]
                );
                displayPendingApps(response.documents);
            } catch (error) {
                console.error("Error fetching pending apps:", error);
                pendingAppsContainer.innerHTML = `
                    <div class="col-span-full text-center p-8 bg-red-900 bg-opacity-30 rounded-lg border border-red-700">
                        <p class="text-red-300 font-bold mb-2">Error loading pending applications.</p>
                        <p class="text-red-400 text-sm">Please check Appwrite configuration or network.</p>
                    </div>
                `;
            }
        }

        /**
         * Renders the fetched pending apps into the UI.
         * @param {Array} apps - An array of app documents from Appwrite.
         */
        function displayPendingApps(apps) {
            pendingAppsContainer.innerHTML = ''; // Clear previous content

            if (apps.length === 0) {
                pendingAppsContainer.innerHTML = `
                    <div class="col-span-full text-center p-8 bg-gray-800 rounded-lg border border-purple-700">
                        <p class="text-gray-400">No pending applications at this time. All clear!</p>
                    </div>
                `;
                return;
            }

            apps.forEach(app => {
                const submissionDate = new Date(app.submissionDate).toLocaleString();
                const appCard = `
                    <div class="card-container flex flex-col">
                        <div class="flex items-start mb-4">
                            <img src="${app.appLogoUrl || 'https://placehold.co/80x80/A020F0/FFFFFF?text=Logo'}" alt="${app.appName} Logo"
                                 class="w-20 h-20 rounded-xl mr-4 border-2 border-purple-500 object-cover"
                                 onerror="this.onerror=null;this.src='https://placehold.co/80x80/A020F0/FFFFFF?text=Logo';">
                            <div class="flex-grow">
                                <h3 class="text-2xl font-bold text-purple-300 mb-1">${app.appName}</h3>
                                <p class="text-sm text-gray-400 mb-1">by ${app.developerName}</p>
                                <p class="text-xs text-gray-500">Submitted: ${submissionDate}</p>
                            </div>
                        </div>

                        <div class="mb-4 text-sm">
                            <p class="text-gray-300 mb-2 font-semibold">Short Description:</p>
                            <p class="text-gray-400 mb-4">${app.shortDescription}</p>
                            <p class="text-gray-300 mb-2 font-semibold">Long Description:</p>
                            <p class="text-gray-400">${app.longDescription}</p>
                        </div>

                        <div class="mb-4 text-sm grid grid-cols-2 gap-y-2">
                            <p><strong class="text-purple-300">Category:</strong> <span class="text-gray-400">${app.appCategory}</span></p>
                            <p><strong class="text-purple-300">Method:</strong> <span class="text-gray-400">${app.distributionMethod.toUpperCase()}</span></p>
                            <p class="col-span-2"><strong class="text-purple-300">Dev Email:</strong> <span class="text-gray-400">${app.developerEmail}</span></p>
                        </div>

                        <!-- Screenshots Preview -->
                        <div class="mb-4">
                            <p class="text-purple-300 text-sm font-semibold mb-2">Screenshots:</p>
                            <div class="grid grid-cols-2 gap-2">
                                ${app.appImageUrls.map(url => `
                                    <img src="${url}" alt="Screenshot" 
                                         class="w-full h-28 object-cover rounded-md border border-gray-700"
                                         onerror="this.onerror=null;this.src='https://placehold.co/120x80/333333/AAAAAA?text=No+Image';">
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex justify-end gap-3 mt-auto pt-4 border-t border-gray-700">
                            ${app.distributionMethod === 'website' && !app.apkUrl ? `
                                <button data-id="${app.$id}" data-name="${app.appName}" class="btn-upload-apk btn-action">Upload APK</button>
                            ` : app.apkUrl ? `
                                <a href="${app.apkUrl}" download class="btn-action bg-gray-700 hover:bg-gray-600 text-white flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    View APK
                                </a>
                            ` : ''}
                            <button data-id="${app.$id}" class="btn-approve btn-action">Approve</button>
                            <button data-id="${app.$id}" class="btn-reject btn-action">Reject</button>
                        </div>
                    </div>
                `;
                pendingAppsContainer.insertAdjacentHTML('beforeend', appCard);
            });

            // Attach event listeners to newly created buttons
            document.querySelectorAll('.btn-approve').forEach(button => {
                button.addEventListener('click', (event) => handleApprove(event.target.dataset.id));
            });
            document.querySelectorAll('.btn-reject').forEach(button => {
                button.addEventListener('click', (event) => handleReject(event.target.dataset.id));
            });
            document.querySelectorAll('.btn-upload-apk').forEach(button => {
                button.addEventListener('click', (event) => {
                    const appId = event.target.dataset.id;
                    const appName = event.target.dataset.name;
                    showApkUploadModal(appId, appName);
                });
            });
        }

        /**
         * Handles the approval of an application.
         * @param {string} appId - The ID of the app document to approve.
         */
        async function handleApprove(appId) {
            showMessageBox(
                'Confirm Approval',
                'Are you sure you want to approve this application? It will become publicly visible.',
                async () => {
                    try {
                        await databases.updateDocument(
                            APPWRITE_DATABASE_ID,
                            APPWRITE_COLLECTION_ID,
                            appId,
                            {
                                status: 'approved',
                                reviewedBy: 'Admin User', // Placeholder admin name
                                reviewDate: new Date().toISOString()
                            }
                        );
                        showMessageBox('Success', 'Application approved successfully!');
                        fetchPendingApps(); // Refresh the list
                    } catch (error) {
                        console.error("Error approving app:", error);
                        showMessageBox('Error', `Failed to approve application: ${error.message}`);
                    }
                }
            );
        }

        /**
         * Handles the rejection of an application.
         * @param {string} appId - The ID of the app document to reject.
         */
        async function handleReject(appId) {
            showMessageBox(
                'Confirm Rejection',
                'Are you sure you want to reject this application? It will not be listed.',
                async () => {
                    try {
                        await databases.updateDocument(
                            APPWRITE_DATABASE_ID,
                            APPWRITE_COLLECTION_ID,
                            appId,
                            {
                                status: 'rejected',
                                reviewedBy: 'Admin User', // Placeholder admin name
                                reviewDate: new Date().toISOString()
                            }
                        );
                        showMessageBox('Success', 'Application rejected successfully!');
                        fetchPendingApps(); // Refresh the list
                    } catch (error) {
                        console.error("Error rejecting app:", error);
                        showMessageBox('Error', `Failed to reject application: ${error.message}`);
                    }
                }
            );
        }

        // Initial fetch when the page loads
        document.addEventListener('DOMContentLoaded', fetchPendingApps);
    </script>
</body>
</html>
