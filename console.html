// Appwrite SDK Client and Database initialization
import { Client, Databases, Query } from 'https://cdn.jsdelivr.net/npm/appwrite@11.0.0/dist/esm/sdk.js';

// --- Appwrite Configuration ---
const APPWRITE_ENDPOINT = 'https://cloud.appwrite.io/v1'; // Your Appwrite Endpoint
const APPWRITE_PROJECT_ID = '68528057001314063369'; // Your Appwrite Project ID
const DATABASE_ID = '6852a77b0029f40ae7a4'; // Your Appwrite Database ID
const COLLECTION_ID = '6852a7a3001e4713b6f6'; // Your Appwrite Collection ID for app submissions

const client = new Client();
client
    .setEndpoint(APPWRITE_ENDPOINT)
    .setProject(APPWRITE_PROJECT_ID);

const databases = new Databases(client);

document.addEventListener('DOMContentLoaded', async () => {
    // Add a class to the body for console-specific styling
    document.body.classList.add('console-page');

    // --- Console UI Elements ---
    const pendingAppsList = document.getElementById('pendingAppsList');
    const acceptedAppsList = document.getElementById('acceptedAppsList');
    const rejectedAppsList = document.getElementById('rejectedAppsList');

    const appDetailModal = document.getElementById('appDetailModal');
    const modalCloseButton = appDetailModal.querySelector('.console-close-button');
    const modalAppName = document.getElementById('modalAppName');
    const modalDeveloperName = document.getElementById('modalDeveloperName');
    const modalDeveloperEmail = document.getElementById('modalDeveloperEmail');
    const modalAppCategory = document.getElementById('modalAppCategory');
    const modalDistributionMethod = document.getElementById('modalDistributionMethod');
    const modalWebsiteUrlRow = document.getElementById('modalWebsiteUrlRow');
    const modalWebsiteUrl = document.getElementById('modalWebsiteUrl');
    const modalApkUrlRow = document.getElementById('modalApkUrlRow');
    const modalApkUrl = document.getElementById('modalApkUrl');
    const modalShortDescription = document.getElementById('modalShortDescription');
    const modalLongDescription = document.getElementById('modalLongDescription');
    const modalAppLogo = document.getElementById('modalAppLogo');
    const modalAppScreenshots = document.getElementById('modalAppScreenshots');
    const modalAcceptButton = appDetailModal.querySelector('.accept-btn');
    const modalRejectButton = appDetailModal.querySelector('.reject-btn');

    let currentAppDocId = null; // To store the ID of the app currently in the modal

    // Function to show custom message box for console
    const consoleMessageBoxContainer = document.getElementById('consoleMessageBoxContainer');
    const consoleMessageBoxTitle = document.getElementById('consoleMessageBoxTitle');
    const consoleMessageBoxMessage = document.getElementById('consoleMessageBoxMessage');
    const consoleOkButton = document.querySelector('.console-ok-button');

    function showConsoleMessageBox(title, message) {
        consoleMessageBoxTitle.textContent = title;
        consoleMessageBoxMessage.textContent = message;
        consoleMessageBoxContainer.style.display = 'flex'; // Show it
        document.body.style.overflow = 'hidden'; // Prevent body scroll
    }

    if (consoleOkButton) {
        consoleOkButton.addEventListener('click', () => {
            consoleMessageBoxContainer.style.display = 'none';
            document.body.style.overflow = ''; // Restore body scroll
        });
    }


    // Function to render app cards
    function renderAppCards(apps) {
        pendingAppsList.innerHTML = '';
        acceptedAppsList.innerHTML = '';
        rejectedAppsList.innerHTML = '';

        const pending = apps.filter(app => app.status === 'Pending');
        const approved = apps.filter(app => app.status === 'Approved'); // Changed from 'Accepted' to 'Approved'
        const rejected = apps.filter(app => app.status === 'Rejected');

        if (pending.length === 0) pendingAppsList.innerHTML = '<p class="no-apps-message">No pending applications.</p>';
        if (approved.length === 0) acceptedAppsList.innerHTML = '<p class="no-apps-message">No accepted applications.</p>';
        if (rejected.length === 0) rejectedAppsList.innerHTML = '<p class="no-apps-message">No rejected applications.</p>';


        pending.forEach(app => pendingAppsList.appendChild(createAppCard(app)));
        approved.forEach(app => acceptedAppsList.appendChild(createAppCard(app))); // Use 'approved'
        rejected.forEach(app => rejectedAppsList.appendChild(createAppCard(app)));
    }

    function createAppCard(app) {
        const card = document.createElement('div');
        card.classList.add('app-card-console');

        card.innerHTML = `
            <div class="app-header">
                <img src="${app.appLogoUrl || 'https://placehold.co/60x60/007bff/ffffff?text=LOGO'}" alt="${app.appName} Logo" class="app-logo" onerror="this.onerror=null;this.src='https://placehold.co/60x60/007bff/ffffff?text=LOGO';">
                <h3>${app.appName}</h3>
            </div>
            <p>${app.shortDescription}</p>
            <p class="developer-info">Developer: ${app.developerName}</p>
            <p class="developer-info">Category: ${app.appCategory}</p>
            <span class="status ${app.status.toLowerCase()}">${app.status}</span>
            <div class="card-actions">
                <button class="view-details-btn" data-id="${app.$id}">View Details</button>
            </div>
        `;

        // Add Approve/Reject buttons only for Pending apps
        if (app.status === 'Pending') {
            const actionsDiv = card.querySelector('.card-actions');
            const approveBtn = document.createElement('button');
            approveBtn.classList.add('approve-btn'); // Changed from accept-btn
            approveBtn.textContent = 'Approve';
            approveBtn.dataset.id = app.$id;
            approveBtn.addEventListener('click', () => handleStatusChange(app.$id, 'Approved', app.appName, app.developerName, app.developerEmail));
            actionsDiv.appendChild(approveBtn);

            const rejectBtn = document.createElement('button');
            rejectBtn.classList.add('reject-btn');
            rejectBtn.textContent = 'Reject';
            rejectBtn.dataset.id = app.$id;
            rejectBtn.addEventListener('click', () => handleStatusChange(app.$id, 'Rejected', app.appName, app.developerName, app.developerEmail));
            actionsDiv.appendChild(rejectBtn);
        }

        // Add event listener for View Details button
        card.querySelector('.view-details-btn').addEventListener('click', () => showAppDetails(app.$id, app));

        return card;
    }

    // Function to show app details in modal
    function showAppDetails(docId, appData) {
        currentAppDocId = docId; // Store for accept/reject actions

        modalAppName.textContent = appData.appName;
        modalDeveloperName.textContent = appData.developerName;
        modalDeveloperEmail.textContent = appData.developerEmail;
        modalAppCategory.textContent = appData.appCategory;
        modalDistributionMethod.textContent = appData.distributionMethod === 'url' ? 'Website URL' : 'APK Upload';
        modalShortDescription.textContent = appData.shortDescription;
        modalLongDescription.textContent = appData.longDescription;
        modalAppLogo.src = appData.appLogoUrl || 'https://placehold.co/120x120/007bff/ffffff?text=LOGO';
        modalAppLogo.onerror = function() { this.src = 'https://placehold.co/120x120/007bff/ffffff?text=LOGO'; };


        // Display website URL or APK URL
        if (appData.distributionMethod === 'url') {
            modalWebsiteUrlRow.style.display = 'block';
            modalApkUrlRow.style.display = 'none';
            modalWebsiteUrl.href = appData.websiteUrl;
            modalWebsiteUrl.textContent = appData.websiteUrl;
        } else {
            modalWebsiteUrlRow.style.display = 'none';
            modalApkUrlRow.style.display = 'block';
            modalApkUrl.href = appData.apkUrl || '#'; // Fallback for APK
            modalApkUrl.textContent = appData.apkUrl ? 'Download APK' : 'APK Not Available';
        }

        // Display screenshots
        modalAppScreenshots.innerHTML = '';
        if (appData.appImageUrls) {
            const imageUrls = typeof appData.appImageUrls === 'string' ? appData.appImageUrls.split(',') : appData.appImageUrls;

            if (imageUrls && imageUrls.length > 0) {
                imageUrls.forEach(url => {
                    const screenshotItem = document.createElement('div');
                    screenshotItem.classList.add('screenshot-item');
                    const img = document.createElement('img');
                    img.src = url;
                    img.onerror = function() { this.src = 'https://placehold.co/200x112.5/AAAAAA/000000?text=Image+Error'; }; // Placeholder on error
                    screenshotItem.appendChild(img);
                    modalAppScreenshots.appendChild(screenshotItem);

                    // Basic aspect ratio check for styling (can be improved with actual image dimensions)
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        const aspectRatio = tempImg.width / tempImg.height;
                        if (Math.abs(aspectRatio - (9 / 16)) < 0.01) { // Check for portrait
                            screenshotItem.classList.add('portrait');
                        }
                    };
                    tempImg.src = url; // Load image to check dimensions
                });
            } else {
                modalAppScreenshots.innerHTML = '<p style="color:var(--light-text-color); font-size:0.9em;">No screenshots available.</p>';
            }
        } else {
             modalAppScreenshots.innerHTML = '<p style="color:var(--light-text-color); font-size:0.9em;">No screenshots available.</p>';
        }


        // Set up Accept/Reject buttons in modal
        if (appData.status === 'Pending') {
            modalAcceptButton.style.display = 'inline-block';
            modalRejectButton.style.display = 'inline-block';
            modalAcceptButton.onclick = () => {
                handleStatusChange(currentAppDocId, 'Approved', appData.appName, appData.developerName, appData.developerEmail);
                appDetailModal.style.display = 'none'; // Close modal after action
            };
            modalRejectButton.onclick = () => {
                handleStatusChange(currentAppDocId, 'Rejected', appData.appName, appData.developerName, appData.developerEmail);
                appDetailModal.style.display = 'none'; // Close modal after action
            };
        } else {
            modalAcceptButton.style.display = 'none';
            modalRejectButton.style.display = 'none';
        }

        appDetailModal.style.display = 'flex'; // Show modal
        document.body.style.overflow = 'hidden'; // Prevent scrolling body
    }

    // Close Modal event listener
    modalCloseButton.addEventListener('click', () => {
        appDetailModal.style.display = 'none';
        document.body.style.overflow = '';
        currentAppDocId = null; // Clear active app ID
    });

    // Close Modal if clicked outside content
    window.addEventListener('click', (event) => {
        if (event.target == appDetailModal) {
            appDetailModal.style.display = 'none';
            document.body.style.overflow = '';
            currentAppDocId = null;
        }
    });


    // Function to handle status change (Approve/Reject)
    async function handleStatusChange(docId, newStatus, appName, developerName, developerEmail) {
        try {
            await databases.updateDocument(
                DATABASE_ID,
                COLLECTION_ID,
                docId,
                { status: newStatus }
            );

            showConsoleMessageBox('Success', `App "${appName}" has been set to "${newStatus}".`);
            console.log(`App ${docId} status updated to ${newStatus}`);

            // Prepare and open email client for notification
            const subject = encodeURIComponent(`LoomStore App Status Update: ${appName} - ${newStatus}`);
            const body = encodeURIComponent(`Dear ${developerName},\n\nThis is an update regarding your app submission "${appName}" to LoomStore.\n\nYour app status has been changed to: ${newStatus}.\n\n${newStatus === 'Approved' ? 'Congratulations! Your app has been accepted and will be listed on LoomStore soon.' : 'We regret to inform you that your app has been rejected. For more details or to appeal, please contact support.'}\n\nLoomStore Team`);
            window.open(`mailto:${developerEmail}?subject=${subject}&body=${body}`, '_blank');

        } catch (error) {
            console.error(`Error updating app status for ${docId}:`, error);
            showConsoleMessageBox('Error', `Failed to update app status: ${error.message}`);
        }
    }

    // Appwrite Listener (Real-time updates)
    client.subscribe(`databases.${DATABASE_ID}.collections.${COLLECTION_ID}.documents`, response => {
        // Ensure to fetch all submissions again to re-render the categorized lists
        console.log("Realtime update received in console, refreshing app lists.");
        fetchAppSubmissions();
    });

    // Function to initially fetch and display app submissions
    async function fetchAppSubmissions() {
        try {
            console.log("Fetching app submissions for console...");
            const response = await databases.listDocuments(
                DATABASE_ID,
                COLLECTION_ID,
                // Appwrite's listDocuments does not directly support multiple orderBys without indexes
                // Fetch all and sort in memory if needed, or add indexes in Appwrite console.
                // For now, no specific ordering is applied here, it's just fetching all.
            );
            console.log("Fetched app submissions:", response.documents);
            renderAppCards(response.documents);
        } catch (error) {
            console.error("Error fetching app submissions for console:", error);
            showConsoleMessageBox('Data Error', 'Failed to load app submissions. Please check your Appwrite setup and permissions.');
        }
    }

    // Initial fetch when the console page loads
    fetchAppSubmissions();
});
