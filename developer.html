<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Submission - LoomStore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@appwrite.io/sdk@15.0.0/dist/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1491.0/aws-sdk.min.js"></script>
    <style>
        body {
            background: #000000;
            color: white;
            font-family: 'Inter', sans-serif;
        }
        .form-group label {
            transition: color 0.3s ease;
        }
        .form-group input:focus + label,
        .form-group select:focus + label {
            color: #a020f0;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #a020f0;
            box-shadow: 0 0 0 3px rgba(160, 32, 240, 0.2);
        }
        .error {
            color: #ff4444;
            font-size: 0.875rem;
        }
        .btn-purple {
            background: linear-gradient(90deg, #a020f0, #c084fc);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-purple:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(160, 32, 240, 0.5);
        }
        .upload-area {
            transition: background-color 0.3s ease;
        }
        .upload-area:hover {
            background-color: rgba(160, 32, 240, 0.1);
        }
    </style>
</head>
<body class="p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-[#a020f0]">Submit Your App</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
    </div>
    <form id="submissionForm" class="space-y-6">
        <div class="form-group">
            <label for="appLogo" class="block text-sm font-medium">App Logo (1:1)</label>
            <input type="file" id="appLogo" accept="image/*" class="hidden">
            <div class="mt-2 p-4 bg-gray-900 rounded-lg border border-gray-700 text-center upload-area cursor-pointer">
                <span id="appLogoText">Upload Logo</span>
            </div>
            <p id="appLogoError" class="error hidden mt-1"></p>
        </div>
        <div class="form-group">
            <label for="appName" class="block text-sm font-medium">App Name</label>
            <input type="text" id="appName" class="w-full p-3 bg-gray-900 rounded-lg border border-gray-700" maxlength="50">
            <p id="appNameError" class="error hidden mt-1"></p>
        </div>
        <div class="form-group">
            <label for="shortDescription" class="block text-sm font-medium">Short Description (max 50 chars)</label>
            <input type="text" id="shortDescription" class="w-full p-3 bg-gray-900 rounded-lg border border-gray-700" maxlength="50">
            <p id="shortDescriptionError" class="error hidden mt-1"></p>
        </div>
        <div class="form-group">
            <label for="longDescription" class="block text-sm font-medium">Long Description (max 300 chars)</label>
            <textarea id="longDescription" class="w-full p-3 bg-gray-900 rounded-lg border border-gray-700" maxlength="300"></textarea>
            <p id="longDescriptionError" class="error hidden mt-1"></p>
        </div>
        <div class="form-group">
            <label for="appScreenshots" class="block text-sm font-medium">App Screenshots (16:9 or 9:16, 2+)</label>
            <input type="file" id="appScreenshots" accept="image/*" multiple class="hidden">
            <div class="mt-2 p-4 bg-gray-900 rounded-lg border border-gray-700 text-center upload-area cursor-pointer">
                <span id="appScreenshotsText">Upload Screenshots</span>
            </div>
            <p id="appScreenshotsError" class="error hidden mt-1"></p>
        </div>
        <div class="form-group">
            <label for="appCategory" class="block text-sm font-medium">App Category</label>
            <select id="appCategory" class="w-full p-3 bg-gray-900 rounded-lg border border-gray-700">
                <option value="Games">Games</option>
                <option value="Productivity">Productivity</option>
                <option value="Social">Social</option>
                <option value="Utilities">Utilities</option>
            </select>
        </div>
        <div class="form-group">
            <label class="block text-sm font-medium">Distribution Method</label>
            <div class="flex space-x-4 mt-2">
                <label class="flex items-center">
                    <input type="radio" name="distribution" value="apk" checked class="text-[#a020f0] focus:ring-[#a020f0]">
                    <span class="ml-2">APK Upload</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="distribution" value="website" class="text-[#a020f0] focus:ring-[#a020f0]">
                    <span class="ml-2">Website URL</span>
                </label>
            </div>
        </div>
        <div id="apkUpload" class="form-group">
            <label for="apkFile" class="block text-sm font-medium">Upload APK</label>
            <input type="file" id="apkFile" accept=".apk" class="hidden">
            <div class="mt-2 p-4 bg-gray-900 rounded-lg border border-gray-700 text-center upload-area cursor-pointer">
                <span id="apkFileText">Upload APK</span>
            </div>
            <p id="apkFileError" class="error hidden mt-1"></p>
        </div>
        <div id="websiteUrl" class="form-group hidden">
            <label for="websiteUrlInput" class="block text-sm font-medium">Website URL</label>
            <input type="url" id="websiteUrlInput" class="w-full p-3 bg-gray-900 rounded-lg border border-gray-700">
            <p id="websiteUrlError" class="error hidden mt-1"></p>
        </div>
        <div class="form-group">
            <label for="developerName" class="block text-sm font-medium">Developer Name</label>
            <input type="text" id="developerName" class="w-full p-3 bg-gray-900 rounded-lg border border-gray-700">
            <p id="developerNameError" class="error hidden mt-1"></p>
        </div>
        <div class="form-group">
            <label for="developerEmail" class="block text-sm font-medium">Developer Email</label>
            <input type="email" id="developerEmail" class="w-full p-3 bg-gray-900 rounded-lg border border-gray-700">
            <p id="developerEmailError" class="error hidden mt-1"></p>
        </div>
        <button type="submit" class="btn-purple w-full text-white px-6 py-3 rounded-lg font-semibold">Submit</button>
    </form>

    <script>
        const client = new Appwrite.Client();
        client.setEndpoint('https://cloud.appwrite.io/v1').setProject('68528057001314063369');
        const database = new Appwrite.Databases(client);

        AWS.config.update({
            accessKeyId: 'cFDtuIpumfXlW76M',
            secretAccessKey: 'NVbTrPoAOnJYzeMJ',
            region: 'us-east-1'
        });
        const s3 = new AWS.S3();

        // Handle file input clicks
        document.querySelectorAll('.upload-area').forEach(area => {
            const inputId = area.previousElementSibling.id;
            const input = document.getElementById(inputId);
            area.addEventListener('click', () => input.click());
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('bg-gray-800');
            });
            area.addEventListener('dragleave', () => {
                area.classList.remove('bg-gray-800');
            });
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('bg-gray-800');
                input.files = e.dataTransfer.files;
                input.dispatchEvent(new Event('change'));
            });
        });

        // Update file input text
        document.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', (e) => {
                const textElement = document.getElementById(`${e.target.id}Text`);
                const fileCount = e.target.files.length;
                textElement.textContent = fileCount ? `${fileCount} file${fileCount > 1 ? 's' : ''} selected` : `Upload ${e.target.id.replace(/([A-Z])/g, ' $1').trim()}`;
            });
        });

        // Toggle distribution method
        document.querySelectorAll('input[name="distribution"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const apkUpload = document.getElementById('apkUpload');
                const websiteUrl = document.getElementById('websiteUrl');
                apkUpload.classList.toggle('hidden', e.target.value !== 'apk');
                websiteUrl.classList.toggle('hidden', e.target.value !== 'website');
                // Reset inputs when switching
                document.getElementById('apkFile').value = '';
                document.getElementById('websiteUrlInput').value = '';
                document.getElementById('apkFileText').textContent = 'Upload APK';
                document.getElementById('websiteUrlError').classList.add('hidden');
                document.getElementById('apkFileError').classList.add('hidden');
            });
        });

        function validateImage(file, isLogo = false) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const aspectRatio = img.width / img.height;
                    if (isLogo && Math.abs(aspectRatio - 1) > 0.05) {
                        reject('Logo must be square (1:1).');
                    } else if (!isLogo && ![16/9, 9/16].some(r => Math.abs(aspectRatio - r) < 0.05)) {
                        reject('Screenshots must be 16:9 or 9:16.');
                    } else {
                        resolve();
                    }
                    URL.revokeObjectURL(img.src);
                };
                img.onerror = () => reject('Invalid image file.');
            });
        }

        async function uploadFile(file, path) {
            try {
                const params = {
                    Bucket: 'loomstore',
                    Key: path,
                    Body: file,
                    ContentType: file.type,
                    ACL: 'public-read'
                };
                const data = await s3.upload(params).promise();
                return data.Location;
            } catch (error) {
                throw new Error(`Failed to upload ${path.split('/')[0]}: ${error.message}`);
            }
        }

        document.getElementById('submissionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errors = document.querySelectorAll('.error');
            errors.forEach(err => err.classList.add('hidden'));

            const formData = {
                appLogo: document.getElementById('appLogo').files[0],
                appName: document.getElementById('appName').value.trim(),
                shortDescription: document.getElementById('shortDescription').value.trim(),
                longDescription: document.getElementById('longDescription').value.trim(),
                appScreenshots: Array.from(document.getElementById('appScreenshots').files),
                appCategory: document.getElementById('appCategory').value,
                distributionMethod: document.querySelector('input[name="distribution"]:checked').value,
                apkFile: document.getElementById('apkFile').files[0],
                websiteUrl: document.getElementById('websiteUrlInput').value.trim(),
                developerName: document.getElementById('developerName').value.trim(),
                developerEmail: document.getElementById('developerEmail').value.trim(),
                submissionDate: new Date().toISOString(),
                status: 'pending'
            };

            try {
                // Validate inputs
                if (!formData.appLogo) throw new Error('App logo is required.', 'appLogoError');
                await validateImage(formData.appLogo, true);
                if (!formData.appName) throw new Error('App name is required.', 'appNameError');
                if (!formData.shortDescription) throw new Error('Short description is required.', 'shortDescriptionError');
                if (!formData.longDescription) throw new Error('Long description is required.', 'longDescriptionError');
                if (formData.appScreenshots.length < 2) throw new Error('At least 2 screenshots are required.', 'appScreenshotsError');
                for (const screenshot of formData.appScreenshots) {
                    await validateImage(screenshot);
                }
                if (formData.distributionMethod === 'apk' && !formData.apkFile) {
                    throw new Error('APK file is required.', 'apkFileError');
                }
                if (formData.distributionMethod === 'website' && !formData.websiteUrl) {
                    throw new Error('Website URL is required.', 'websiteUrlError');
                }
                if (!formData.developerName) throw new Error('Developer name is required.', 'developerNameError');
                if (!formData.developerEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.developerEmail)) {
                    throw new Error('Valid developer email is required.', 'developerEmailError');
                }

                // Upload files to S3
                const appLogoUrl = await uploadFile(formData.appLogo, `logos/${Date.now()}_${formData.appLogo.name}`);
                const appImageUrls = [];
                for (const [index, screenshot] of formData.appScreenshots.entries()) {
                    const url = await uploadFile(screenshot, `screenshots/${Date.now()}_${index}_${screenshot.name}`);
                    appImageUrls.push(url);
                }
                let apkUrl = '';
                if (formData.distributionMethod === 'apk') {
                    apkUrl = await uploadFile(formData.apkFile, `apks/${Date.now()}_${formData.apkFile.name}`);
                }

                // Save metadata to Appwrite
                const metadata = {
                    appName: formData.appName,
                    shortDescription: formData.shortDescription,
                    longDescription: formData.longDescription,
                    appCategory: formData.appCategory,
                    distributionMethod: formData.distributionMethod,
                    websiteUrl: formData.websiteUrl || '',
                    apkUrl,
                    developerName: formData.developerName,
                    developerEmail: formData.developerEmail,
                    submissionDate: formData.submissionDate,
                    status: formData.status,
                    appLogoUrl,
                    appImageUrls
                };

                await database.createDocument(
                    '6852a77b0029f40ae7a4',
                    '6852a7a3001e4713b6f6',
                    'unique()',
                    metadata
                );

                alert('Application submitted successfully!');
                document.getElementById('submissionForm').reset();
                document.querySelectorAll('.upload-area span').forEach(span => {
                    span.textContent = `Upload ${span.id.replace('Text', '').replace(/([A-Z])/g, ' $1').trim()}`;
                });
                closeModal();
            } catch (error) {
                const errorId = error.message.split(',')[1]?.trim() || 'generalError';
                const errorElement = document.getElementById(errorId) || document.createElement('p');
                if (errorId === 'generalError') {
                    errorElement.className = 'error mt-2';
                    errorElement.textContent = error.message.split(',')[0];
                    document.getElementById('submissionForm').appendChild(errorElement);
                } else {
                    errorElement.textContent = error.message.split(',')[0];
                    errorElement.classList.remove('hidden');
                }
            }
        });

        function closeModal() {
            window.parent.postMessage('closeModal', '*');
        }
    </script>
</body>
</html>
